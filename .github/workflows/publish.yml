name: Ktools Release

on:
  # ONLY USE PUSH FOR TESTING --- delete this
  push:
  workflow_dispatch:
    inputs:

      build_branch:
        description: 'Branch of build script repo - https://github.com/OasisLMF/build'
        required: true

      release_tag:
        description: 'Release tag to publish ktools as'
        required: true

      prev_release_tag:
        description: 'The last release, used for generating the changelog'
        required: true

      pre_release:
        description: 'Mark release as pre-release'
        required: true

      auto_merge:
        description: 'Run Git flow, git_merge(source_branch -> master) and then git_merge(master -> develop)'
        required: true


env:
  MAIN_BRANCH: "test-master"
  DEVELOP_BRANCH: "test-develop"
  KTOOLS_WORKSPACE: ${{ github.workspace }}/ktools

  #BUILD_BRANCH: ${{ inputs.build_branch }}
  #RELEASE_TAG: ${{ inputs.release_tag }}
  #PREV_RELEASE_TAG: ${{ inputs.prev_release_tag }}
  #PRE_RELEASE: ${{ inputs.pre_release }}
  #AUTO_MERGE: ${{ inputs.auto_merge }}

# -- TESTING ONLY ----

  BUILD_BRANCH: 'master'
  RELEASE_TAG: 'v3.9.5rc1'
  PREV_RELEASE_TAG: 'v3.9.4'
  PRE_RELEASE: 'true'
  AUTO_MERGE: 'false'


  GIT_USERNAME: 'awsbuild'
  GIT_EMAIL: 'awsbuild@oasislmf.org'

jobs:
  build:
    uses: ./.github/workflows/build.yml
    secrets: inherit
    with:
      create_ktools_builder: 'false'


# https://github.com/marketplace/actions/check-version-format-in-tag
  create_release:
    runs-on: ubuntu-latest
    #needs: build
    steps:

    # -- test version tags ----- #
    - name: Check tag is valid for release
      if: ${{ env.PRE_RELEASE == 'false'}}
      run: |
        echo ${{ env.RELEASE_TAG }} | grep -Eq  "^v(0|[1-9]*)\.(0|[1-9]*)\.(0|[1-9]*)$" && echo 'Passed' || exit 1

    - name: Check tag is valid for pre-release
      if: ${{ env.PRE_RELEASE == 'true'}}
      run: |
        echo ${{ env.RELEASE_TAG }} | grep -Eq  "^v(0|[1-9]*)\.(0|[1-9]*)\.(0|[1-9]*)rc([1-9]*)$" && echo 'Passed' || exit 1

    # -- test can merge ----- #
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        path: ${{ env.KTOOLS_WORKSPACE }}

    - name: Check tag matches built version
      working-directory: ${{ env.KTOOLS_WORKSPACE }}
      run: |
        BUILD_VER=$(cat VERSION.in)
        RELEASE_VER=$(echo ${{ env.RELEASE_TAG }} | cut -c2-)
        [[ "$RELEASE_VER" = "$BUILD_VER" ]] && echo 'Release tag matches version' || exit 1

    - name: Check if tag exisits
      working-directory: ${{ env.KTOOLS_WORKSPACE }}
      run: |
        git rev-parse -q --verify "refs/tags/v3.9.4" && echo "Tag exisits"; exit 1 || echo "Pass"

    - name: Setup github user
      run: |
        git config --global user.email ${{ env.GIT_EMAIL }}
        git config --global user.name ${{ env.GIT_USERNAME }}
        git config --global pull.ff only

    - name: Check for merge conflicts and tag
      working-directory: ${{ env.KTOOLS_WORKSPACE }}
      env:
        GITHUB_TOKEN: ${{ secrets.AWSBUILD_GIT_TOKEN }}
      #if: ${{ env.AUTO_MERGE == 'true'}}
      run: |
        git checkout ${{ env.MAIN_BRANCH }}
        git merge ${{ github.ref_name }} --no-ff --no-commit
        git merge --abort
        git checkout ${{ github.ref_name }}
        git tag ${{ env.RELEASE_TAG }}

    - name: Setup python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Setup Changelog builder
      working-directory: ${{ github.workspace }}
      run: |
        BASE_URL="https://raw.githubusercontent.com/OasisLMF/build/${{ env.BUILD_BRANCH }}/buildscript"
        pip install -r $BASE_URL/requirments_changelog.txt
        wget $BASE_URL/auto_changelog.py
        chmod +x auto_changelog.py

    - name: Create changelog
      working-directory: ${{ env.KTOOLS_WORKSPACE }}
      env:
        GITHUB_TOKEN: ${{ secrets.AWSBUILD_GIT_TOKEN }}
      run: |
        ${{ github.workspace }}/auto_changelog.py build-changelog \
          --repo ktools \
          --from-tag ${{ env.PREV_RELEASE_TAG }} \
          --to-tag ${{ env.RELEASE_TAG }} \
          --github-token ${{ secrets.AWSBUILD_GIT_TOKEN }} \
          --local-repo-path ./ \
          --output-path ./CHANGELOG.rst
         #--apply-milestone

        git add ./CHANGELOG.rst
        git commit -m 'Update changelog'

    - name: Create Release notes
      working-directory: ${{ env.KTOOLS_WORKSPACE }}
      run: |
        ${{ github.workspace }}/auto_changelog.py build-release \
          --repo ktools \
          --from-tag ${{ env.PREV_RELEASE_TAG }} \
          --to-tag ${{ env.RELEASE_TAG }} \
          --github-token ${{ secrets.AWSBUILD_GIT_TOKEN }} \
          --local-repo-path ./ \
          --output-path ./RELEASE.md

    - name: Push changes
      run: |
        git push origin ${{ env.RELEASE_TAG  }}
        git push

    # https://github.com/actions/create-release
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.AWSBUILD_GIT_TOKEN }}
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        release_name: Release ${{ env.RELEASE_TAG }}
        body_path: ${{ env.KTOOLS_WORKSPACE }}/RELEASE.md
        draft: false
        prerelease: ${{ env.PRE_RELEASE }}

    - name: Download Linux binaies
      uses: actions/download-artifact@v3
      with:
        name: Linux_x86_64
        path: Linux_x86_64.tar.gz

    # https://github.com/actions/upload-release-asset
    - name: Upload Linux binaies
      id: upload-release-asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.AWSBUILD_GIT_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
        asset_path: ./Linux_x86_64.tar.gz
        asset_name: Linux_x86_64.tar.gz
        asset_content_type: application/octet-stream

    - name: Download Darwin binaies
      uses: actions/download-artifact@v3
      with:
        name: Darwin_x86_64
        path: Darwin_x86_64.tar.gz

    - name: Upload Darwin binaies
      id: upload-release-asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.AWSBUILD_GIT_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
        asset_path: ./Darwin_x86_64.tar.gz
        asset_name: Darwin_x86_64.tar.gz
        asset_content_type: application/octet-stream

    - name: Run Gitflow (Production)
      working-directory: ${{ env.KTOOLS_WORKSPACE }}
      env:
        GITHUB_TOKEN: ${{ secrets.AWSBUILD_GIT_TOKEN }}
      if: ${{ env.AUTO_MERGE == 'true'}} && ${{ env.PRE_RELEASE == 'false'}}
      run: |
        git checkout ${{ env.MAIN_BRANCH }} && git pull
        git merge ${{ github.ref_name }} && git push
        git checkout ${{ env.DEVELOP_BRANCH }} && git pull
        git merge ${{env.MAIN_BRANCH }} && git push

    - name: Run Gitflow (Release Candidate)
      working-directory: ${{ env.KTOOLS_WORKSPACE }}
      env:
        GITHUB_TOKEN: ${{ secrets.AWSBUILD_GIT_TOKEN }}
      if: ${{ env.AUTO_MERGE == 'true'}} && ${{ env.PRE_RELEASE == 'true'}}
      run: |
        git checkout ${{ env.DEVELOP_BRANCH }} && git pull
        git merge ${{ github.ref_name }} && git push
